// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum userRole {
  SUPERADMIN
  SEKRETARIAT
  BUKUWISUDA
  PETUGAS
}

model user {
  id_user  Int      @id @default(autoincrement())
  username String   @unique
  email    String   @unique
  password String
  role     userRole @default(SUPERADMIN)

  files     file[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model mahasiswa {
  nim               Int     @id
  nama              String
  kelas             String
  prodi             String?
  no_telp           String?
  nama_orang_tua    String?
  judul_skripsi     String?
  dosen_pembimbing  String?
  daerah_asal       String?
  daerah_penempatan String?

  peserta   peserta[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model tamu {
  id_tamu       Int    @id @default(autoincrement())
  nama          String
  email         String
  asal_instansi String

  peserta   peserta[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model presensi {
  id_presensi    Int      @id @default(autoincrement())
  waktu_presensi DateTime @default(now())
  status         Int      @default(0)

  peserta    peserta  @relation(fields: [id_peserta], references: [id_peserta], onDelete: Cascade)
  id_peserta Int      @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model emailSendStatus {
  id_sendStatus Int      @id @default(autoincrement())
  waktu_dikirim DateTime @default(now())//terisi otomatis saat status jadi=2

  //status: 0=gagal, 1=pending (queue), 2=berhasil
  status        Int      @default(1)

  //penambahan kolom 
  errorMessage String? //terisi jika status 0 
  //menunjukan log ini milik kegiatan apa (gladi/wisuda)
  //relasi diarahkan ke tabel 'file' (karena folder disimpan di situ)
  folder        file    @relation("LogFolder", fields: [id_folder],references: [id_file], onDelete: Cascade)
  id_folder     Int

  //relasi ke peserta
  //karena "tambah peserta" dialihkan ke tabel tamu maka id_peserta tidak boleh null
  peserta       peserta? @relation(fields: [id_peserta], references: [id_peserta], onDelete: Cascade)
  id_peserta    Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model file {
  id_file   Int    @id @default(autoincrement())
  file_name String
  path      String @unique
  type      String

  id_parent Int?
  parent    file?  @relation("FolderToSubfolders", fields: [id_parent], references: [id_file],onDelete: Cascade)
  children  file[] @relation("FolderToSubfolders")

  //relasi balik untuk log email(hanya sebagai folder)
  emailLogs   emailSendStatus[] @relation("LogFolder")

  user       user?    @relation(fields: [id_user], references: [id_user], onDelete: Cascade)
  id_user    Int
  peserta    peserta? @relation(fields: [id_peserta], references: [id_peserta], onDelete: Cascade)
  id_peserta Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model peserta {
  id_peserta Int    @id @default(autoincrement())
  jenis      String
  nim        Int?   @unique
  id_tamu    Int?   @unique

  mahasiswa       mahasiswa?        @relation(fields: [nim], references: [nim], onDelete: Cascade)
  tamu            tamu?             @relation(fields: [id_tamu], references: [id_tamu], onDelete: Cascade)
  files           file[]
  emailsendstatus emailSendStatus[]
  presensis       presensi[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum userRole {
  SUPERADMIN
  SEKRETARIAT
  BUKUWISUDA
  PETUGAS
}

model user {
  id_user  Int      @id @default(autoincrement())
  username String   @unique
  email    String   @unique
  password String
  role     userRole @default(SUPERADMIN)

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  presensis presensi[]
  files     file[]
}

model settings {
  id_settings Int    @id @default(autoincrement())
  key         String @unique
  value       String
}

model mahasiswa {
  nim               Int     @id
  nama              String
  kelas             String
  prodi             String?
  no_telp           String?
  nama_orang_tua    String?
  judul_skripsi     String?
  dosen_pembimbing  String?
  daerah_asal       String?
  daerah_penempatan String?
  no_kursi          String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  peserta   peserta[]
}

model tamu {
  id_tamu       Int    @id @default(autoincrement())
  nama          String
  email         String
  asal_instansi String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  peserta   peserta[]
}

model presensi {
  id_presensi    Int      @id @default(autoincrement())
  id_user        Int      
  id_peserta     Int      
  waktu_presensi DateTime @default(now())
  status         Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  peserta   peserta  @relation(fields: [id_peserta], references: [id_peserta], onDelete: Cascade)
  user      user?    @relation(fields: [id_user], references: [id_user])
}

model emailSendStatus {
  id_sendStatus Int  @id @default(autoincrement())
  id_peserta    Int?
  id_folder     Int

  //status: 0=gagal, 1=pending (queue), 2=berhasil

  //penambahan kolom 
  status        Int      @default(1)
  waktu_dikirim DateTime @default(now()) //terisi otomatis saat status jadi=2
  errorMessage  String? //terisi jika status 0 
  //menunjukan log ini milik kegiatan apa (gladi/wisuda)
  //relasi diarahkan ke tabel 'file' (karena folder disimpan di situ)

  //relasi ke peserta
  //karena "tambah peserta" dialihkan ke tabel tamu maka id_peserta tidak boleh null
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  folder    file     @relation("LogFolder", fields: [id_folder], references: [id_file], onDelete: Cascade)
  peserta   peserta? @relation(fields: [id_peserta], references: [id_peserta], onDelete: Cascade)
}

model file {
  id_file    Int    @id @default(autoincrement())
  id_user    Int
  id_peserta Int?
  id_parent  Int?
  file_name  String
  path       String @unique
  type       String

  //relasi balik untuk log email(hanya sebagai folder)

  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  parent    file?             @relation("FolderToSubfolders", fields: [id_parent], references: [id_file], onDelete: Cascade)
  children  file[]            @relation("FolderToSubfolders")
  user      user?             @relation(fields: [id_user], references: [id_user], onDelete: Cascade)
  peserta   peserta?          @relation(fields: [id_peserta], references: [id_peserta], onDelete: Cascade)
  emailLogs emailSendStatus[] @relation("LogFolder")
}

model peserta {
  id_peserta Int    @id @default(autoincrement())
  jenis      String
  nim        Int?   @unique
  id_tamu    Int?   @unique

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  mahasiswa       mahasiswa?        @relation(fields: [nim], references: [nim], onDelete: Cascade)
  tamu            tamu?             @relation(fields: [id_tamu], references: [id_tamu], onDelete: Cascade)
  files           file[]
  emailsendstatus emailSendStatus[]
  presensis       presensi[]
}
